{% extends 'base.html' %}
{% load thumbnail %}
{% load humanize %}
{% block content %}
<div>
	<h1 class="text-center">{{ topic.title }}</h1>
		<p>Хороших голосов: {{ topic.good_vote }}</p>
		<p>Плохих отзывов: {{ topic.bad_vote }}</p>
		{% if user.is_authenticated %}
			{% if topic.user != user %}
				<a href="{% url 'good_vote' topic.id %}">Хороший топик</a>
				<a href="{% url 'bad_vote' topic.id %}">Плохой топик</a>
			{% endif %}
		{% endif %}

	<p>{{ topic.user }}</p>
	{% if topic.user.avatar %}
		{% thumbnail topic.user.avatar "100x100" crop="center" as im %}
			<img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
		{% endthumbnail %}
	{% endif %}
	<p>{{ topic.title }}</p>
	{{ topic.description|safe }}
	<p>{{ topic.created_at|naturaltime }}</p>
</div>

	{% if user == topic.user %}
		<a href="{% url 'edit_topic' topic.id %}">Редактировать</a>
		<a href="{% url 'del_topic' topic.id %}">Удалить</a>
	{% endif %}

	{% if user.is_authenticated %}
		<a href="{% url 'moderated' topic.id %}">Жалоба модератору</a>
		<a href="{% url 'personal_message' topic.id %}">Написать топикпастеру</a>
	{% endif %}


<h2>Комментарии ({{ topic.posts.count }})</h2>

<div>
	{% for post in posts %}
		<div>
			{% if post.user == user %}
				<p>Вы</p>
			{% else %}
				<p>{{ post.user }}</p>
			{% endif %}
			{% if post.user.avatar %}
				{% thumbnail post.user.avatar "100x100" crop="center" as im %}
					<img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
				{% endthumbnail %}
			{% endif %}
			{{ post.message }}
			<p>{{ post.created_at|naturaltime }}</p>
			{% if user == post.user %}
				<a href="{% url 'edit_post' post.id %}" class="edit-post-button">Редактировать</a>
				<a href="{% url 'del_post' post.id %}" class="delete-post-button">Удалить</a>
			{% endif %}
		</div>
		<div class="edit-post"></div>
	{% endfor %}
</div>

{% if user.is_authenticated %}
<div class="container">
	<div class="row">
		<div class="col-md-12">
			<div class="widget-area no-padding blank">
				<div class="status-upload">
						{% include 'topic/add-post.html' %}
				</div>
			</div>
		</div>
	</div>
</div>
{% else %}
	<div class="alert alert-danger" role="alert">Только зарегистрированные пользователи могут оставлять комментарии. <a href="{% url 'login' %}">Войдите,</a> пожалуйста.</div>
{% endif %}


<script>
$('.edit-post-button').on('click', function(e){
	e.preventDefault();
	$.get($(this).attr('href'), function(data) {
		$(".edit-post_{{ post.id }}").html(data);
	});
});
</script>
{% endblock %}